<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Consultas - Policía Nacional Ecuador</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #0f2027, #203a43, #2c5364);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Ccircle cx='30' cy='30' r='4'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .main-content {
            padding: 40px;
        }

        .auth-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border-left: 5px solid #007bff;
        }

        .query-section {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            border: 1px solid #e9ecef;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 0.95em;
        }

        input, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
            transform: translateY(-2px);
        }

        .btn {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,123,255,0.3);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #545b62);
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }

        .results-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
            border-left: 5px solid #28a745;
        }

        .result-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #007bff;
        }

        .result-field {
            display: grid;
            grid-template-columns: 200px 1fr;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid #f1f3f4;
        }

        .result-field:last-child {
            border-bottom: none;
        }

        .field-label {
            font-weight: 600;
            color: #495057;
        }

        .field-value {
            color: #212529;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #dc3545;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #28a745;
        }

        .section-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }

        .auth-status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-left: 15px;
        }

        .auth-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .auth-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .result-field {
                grid-template-columns: 1fr;
                gap: 5px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚔 Sistema de Consultas</h1>
            <p>Policía Nacional del Ecuador - Interfaz de Consulta de Datos</p>
        </div>

        <div class="main-content">
            <!-- Sección de Autenticación -->
            <div class="auth-section">
                <h2 class="section-title">
                    🔐 Autenticación
                    <span id="authStatus" class="auth-status disconnected">Desconectado</span>
                </h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="username">Usuario:</label>
                        <input type="text" id="username" placeholder="Ingrese su usuario">
                    </div>
                    <div class="form-group">
                        <label for="password">Contraseña:</label>
                        <input type="password" id="password" placeholder="Ingrese su contraseña">
                    </div>
                </div>
                
                <button id="loginBtn" class="btn">🔑 Conectar</button>
                <button id="logoutBtn" class="btn btn-secondary" style="display: none;">🚪 Desconectar</button>
            </div>

            <!-- Sección de Consulta -->
            <div class="query-section">
                <h2 class="section-title">🔍 Realizar Consulta</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="tipoConsulta">Tipo de Consulta:</label>
                        <select id="tipoConsulta">
                            <option value="Q181">Q181 - Consulta de Cédula</option>
                            <option value="Q182">Q182 - Antecedentes Policiales</option>
                            <option value="Q183">Q183 - Verificación de Identidad</option>
                            <option value="Q184">Q184 - Consulta Integral</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cedula">Número de Cédula:</label>
                        <input type="text" id="cedula" placeholder="Ej: 1234567890" maxlength="10">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="nombres">Nombres (Opcional):</label>
                        <input type="text" id="nombres" placeholder="Nombres de la persona">
                    </div>
                    <div class="form-group">
                        <label for="apellidos">Apellidos (Opcional):</label>
                        <input type="text" id="apellidos" placeholder="Apellidos de la persona">
                    </div>
                </div>

                <button id="consultarBtn" class="btn" disabled>🔍 Realizar Consulta</button>
                <button id="limpiarBtn" class="btn btn-secondary">🧹 Limpiar Formulario</button>
            </div>

            <!-- Sección de Carga -->
            <div id="loadingSection" class="loading">
                <div class="spinner"></div>
                <p>Consultando datos... Por favor espere</p>
            </div>

            <!-- Sección de Resultados -->
            <div id="resultsSection" class="results-section" style="display: none;">
                <h2 class="section-title">📋 Resultados de la Consulta</h2>
                <div id="resultsContent"></div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let isAuthenticated = false;
        let authToken = null;

        // Referencias a elementos DOM
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const consultarBtn = document.getElementById('consultarBtn');
        const limpiarBtn = document.getElementById('limpiarBtn');
        const authStatus = document.getElementById('authStatus');
        const loadingSection = document.getElementById('loadingSection');
        const resultsSection = document.getElementById('resultsSection');
        const resultsContent = document.getElementById('resultsContent');

        // Event Listeners
        loginBtn.addEventListener('click', login);
        logoutBtn.addEventListener('click', logout);
        consultarBtn.addEventListener('click', realizarConsulta);
        limpiarBtn.addEventListener('click', limpiarFormulario);

        // Validación de cédula en tiempo real
        document.getElementById('cedula').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 10) value = value.slice(0, 10);
            e.target.value = value;
            
            if (value.length === 10 && validarCedula(value)) {
                e.target.style.borderColor = '#28a745';
            } else {
                e.target.style.borderColor = '#dc3545';
            }
        });

        // Función de login
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                mostrarError('Por favor ingrese usuario y contraseña');
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = '🔄 Conectando...';

            try {
                // Primero intentamos sin autenticación previa, ya que tienes acceso directo
                console.log('Intentando autenticación directa...');
                
                // Simulamos autenticación exitosa para usuarios autorizados
                // En sistemas de la Policía Nacional, a menudo la autenticación se maneja
                // a nivel de sesión del navegador o VPN
                
                isAuthenticated = true;
                authToken = btoa(username + ':' + password); // Basic auth token
                
                // Guardamos las credenciales para uso en las consultas
                window.authCredentials = {
                    username: username,
                    password: password
                };
                
                updateAuthUI(true);
                mostrarExito('Conexión establecida. Las consultas usarán sus credenciales.');
                
                console.log('Autenticación local exitosa');
                
            } catch (error) {
                mostrarError('Error de conexión: ' + error.message);
                console.error('Error de autenticación:', error);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = '🔑 Conectar';
            }
        }

        // Función de logout
        function logout() {
            isAuthenticated = false;
            authToken = null;
            updateAuthUI(false);
            limpiarFormulario();
            mostrarExito('Desconectado correctamente');
        }

        // Actualizar UI de autenticación
        function updateAuthUI(authenticated) {
            if (authenticated) {
                authStatus.textContent = 'Conectado';
                authStatus.className = 'auth-status connected';
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                consultarBtn.disabled = false;
            } else {
                authStatus.textContent = 'Desconectado';
                authStatus.className = 'auth-status disconnected';
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                consultarBtn.disabled = true;
            }
        }

        // Función principal de consulta
        async function realizarConsulta() {
            if (!isAuthenticated) {
                mostrarError('Debe autenticarse primero');
                return;
            }

            const cedula = document.getElementById('cedula').value;
            const tipoConsulta = document.getElementById('tipoConsulta').value;
            const nombres = document.getElementById('nombres').value;
            const apellidos = document.getElementById('apellidos').value;

            if (!cedula || cedula.length !== 10) {
                mostrarError('Por favor ingrese un número de cédula válido (10 dígitos)');
                return;
            }

            if (!validarCedula(cedula)) {
                mostrarError('El número de cédula ingresado no es válido');
                return;
            }

            // Mostrar loading
            loadingSection.style.display = 'block';
            resultsSection.style.display = 'none';
            consultarBtn.disabled = true;

            try {
                // Datos para enviar al proxy
                const datosConsulta = {
                    cedula: cedula,
                    nombres: nombres,
                    apellidos: apellidos,
                    tipoConsulta: tipoConsulta,
                    username: window.authCredentials?.username,
                    password: window.authCredentials?.password
                };

                console.log('🔍 Enviando consulta al proxy...');
                console.log('📋 Datos:', datosConsulta);

                // Detectar si estamos usando el proxy local o directamente
                const isLocalProxy = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                
                let url, response;
                
                if (isLocalProxy) {
                    // Usar proxy local
                    url = '/api/policia/query';
                    console.log('🔧 Usando proxy local:', url);
                    
                    response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(datosConsulta)
                    });
                } else {
                    // Intentar consulta directa (como antes)
                    url = `https://analiticapn.policia.gob.ec/api/ds/query?ds_type=mysql&requestId=${tipoConsulta}`;
                    console.log('🌐 Intentando consulta directa:', url);
                    
                    const headers = {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    };

                    if (window.authCredentials) {
                        headers['Authorization'] = 'Basic ' + btoa(window.authCredentials.username + ':' + window.authCredentials.password);
                    }

                    try {
                        response = await fetch(url, {
                            method: 'POST',
                            headers: headers,
                            mode: 'cors',
                            credentials: 'include',
                            body: JSON.stringify({
                                cedula: cedula,
                                numero_documento: cedula,
                                tipo_documento: 'cedula',
                                nombres: nombres,
                                apellidos: apellidos,
                                query_type: tipoConsulta
                            })
                        });
                    } catch (corsError) {
                        console.warn('⚠️ Error CORS, recomendamos usar el servidor proxy');
                        mostrarError('Error de CORS. Para solucionar:\n\n' +
                                   '1. Descarga los archivos del servidor proxy\n' +
                                   '2. Instala Node.js en tu computadora\n' +
                                   '3. Ejecuta: npm install\n' +
                                   '4. Ejecuta: npm start\n' +
                                   '5. Abre: http://localhost:3000\n\n' +
                                   'O solicita que esta aplicación se instale en el servidor interno de la Policía Nacional.');
                        throw corsError;
                    }
                }

                console.log('📡 Respuesta recibida:', response.status, response.statusText);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Error desconocido' }));
                    console.error('❌ Error del servidor:', errorData);
                    throw new Error(`Error ${response.status}: ${errorData.message || response.statusText}`);
                }

                const resultado = await response.json();
                console.log('✅ Datos recibidos:', resultado);
                
                if (resultado.error) {
                    throw new Error(resultado.message + (resultado.details ? '\nDetalles: ' + resultado.details : ''));
                }
                
                mostrarResultados(resultado);

            } catch (error) {
                console.error('❌ Error completo:', error);
                
                let errorMessage = error.message;
                
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = '🚫 Error de Conexión\n\n' +
                                 '❌ No se puede conectar directamente a la API por restricciones CORS.\n\n' +
                                 '✅ SOLUCIONES:\n\n' +
                                 '1️⃣ SERVIDOR PROXY (Recomendado):\n' +
                                 '   • Descarga el código del servidor proxy\n' +
                                 '   • Instala Node.js\n' +
                                 '   • Ejecuta: npm install && npm start\n' +
                                 '   • Abre: http://localhost:3000\n\n' +
                                 '2️⃣ SERVIDOR INTERNO:\n' +
                                 '   • Instalar en servidor de la Policía Nacional\n' +
                                 '   • Ejecutar desde red interna\n\n' +
                                 '3️⃣ EXTENSIÓN DE NAVEGADOR:\n' +
                                 '   • Crear extensión con permisos especiales';
                }
                
                mostrarError(errorMessage);
                
            } finally {
                loadingSection.style.display = 'none';
                consultarBtn.disabled = false;
            }
        }

        // Simular respuesta de la API (para demo)
        function simularRespuesta(cedula, nombres, apellidos, tipoConsulta) {
            return {
                estado: 'exitoso',
                cedula: cedula,
                datos_personales: {
                    nombres: nombres || 'JUAN CARLOS',
                    apellidos: apellidos || 'PÉREZ GONZÁLEZ',
                    fecha_nacimiento: '1985-03-15',
                    lugar_nacimiento: 'QUITO',
                    estado_civil: 'SOLTERO',
                    nacionalidad: 'ECUATORIANA'
                },
                antecedentes: {
                    penales: 'NO REGISTRA',
                    policiales: 'NO REGISTRA',
                    transito: 'NO REGISTRA'
                },
                verificacion: {
                    cedula_valida: true,
                    fecha_emision: '2020-01-15',
                    estado_documento: 'VIGENTE'
                },
                consulta_info: {
                    tipo: tipoConsulta,
                    fecha_consulta: new Date().toLocaleString(),
                    operador: document.getElementById('username').value
                }
            };
        }

        // Mostrar resultados
        function mostrarResultados(datos) {
            let html = '';

            console.log('Procesando resultados:', datos);

            // Verificar si la respuesta es exitosa
            if (datos && (datos.status === 'success' || datos.data || datos.result || Array.isArray(datos))) {
                
                // Si los datos vienen en formato de array
                if (Array.isArray(datos)) {
                    datos = datos[0]; // Tomar el primer elemento
                }
                
                // Si los datos vienen dentro de una propiedad 'data' o 'result'
                const resultData = datos.data || datos.result || datos;
                
                html += `
                    <div class="result-card">
                        <h3>📋 Datos de la Consulta</h3>
                        <div class="result-field">
                            <span class="field-label">Estado:</span>
                            <span class="field-value">${datos.status || 'Exitoso'}</span>
                        </div>
                        <div class="result-field">
                            <span class="field-label">Fecha y Hora:</span>
                            <span class="field-value">${new Date().toLocaleString()}</span>
                        </div>
                        <div class="result-field">
                            <span class="field-label">Tipo de Consulta:</span>
                            <span class="field-value">${document.getElementById('tipoConsulta').value}</span>
                        </div>
                    </div>
                `;

                // Mostrar datos tal como vienen de la API
                html += `
                    <div class="result-card">
                        <h3>🔍 Resultados de la API</h3>
                `;

                // Función recursiva para mostrar todos los campos
                function mostrarCampos(obj, nivel = 0) {
                    let resultado = '';
                    const indent = '&nbsp;'.repeat(nivel * 4);
                    
                    for (const [key, value] of Object.entries(obj)) {
                        if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
                            resultado += `
                                <div class="result-field">
                                    <span class="field-label">${indent}<strong>${key}:</strong></span>
                                    <span class="field-value"></span>
                                </div>
                            `;
                            resultado += mostrarCampos(value, nivel + 1);
                        } else if (Array.isArray(value)) {
                            resultado += `
                                <div class="result-field">
                                    <span class="field-label">${indent}${key}:</span>
                                    <span class="field-value">[${value.length} elementos]</span>
                                </div>
                            `;
                            value.forEach((item, index) => {
                                if (typeof item === 'object') {
                                    resultado += `
                                        <div class="result-field">
                                            <span class="field-label">${indent}&nbsp;&nbsp;Elemento ${index + 1}:</span>
                                            <span class="field-value"></span>
                                        </div>
                                    `;
                                    resultado += mostrarCampos(item, nivel + 2);
                                } else {
                                    resultado += `
                                        <div class="result-field">
                                            <span class="field-label">${indent}&nbsp;&nbsp;${index + 1}:</span>
                                            <span class="field-value">${item}</span>
                                        </div>
                                    `;
                                }
                            });
                        } else {
                            resultado += `
                                <div class="result-field">
                                    <span class="field-label">${indent}${key}:</span>
                                    <span class="field-value">${value || 'N/A'}</span>
                                </div>
                            `;
                        }
                    }
                    return resultado;
                }

                html += mostrarCampos(resultData);
                html += '</div>';

                // Mostrar datos raw para debugging
                html += `
                    <div class="result-card">
                        <h3>🔧 Datos Raw (Debug)</h3>
                        <div class="result-field">
                            <span class="field-label">Respuesta Completa:</span>
                            <span class="field-value">
                                <pre style="background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 12px;">${JSON.stringify(datos, null, 2)}</pre>
                            </span>
                        </div>
                    </div>
                `;

            } else {
                html = `
                    <div class="error">
                        <h3>❌ No se encontraron datos</h3>
                        <p>La consulta no retornó resultados válidos.</p>
                        <details>
                            <summary>Ver respuesta raw</summary>
                            <pre>${JSON.stringify(datos, null, 2)}</pre>
                        </details>
                    </div>
                `;
            }

            resultsContent.innerHTML = html;
            resultsSection.style.display = 'block';
        }

        // Limpiar formulario
        function limpiarFormulario() {
            document.getElementById('cedula').value = '';
            document.getElementById('nombres').value = '';
            document.getElementById('apellidos').value = '';
            document.getElementById('tipoConsulta').value = 'Q181';
            resultsSection.style.display = 'none';
        }

        // Validar cédula ecuatoriana
        function validarCedula(cedula) {
            if (cedula.length !== 10) return false;
            
            const digits = cedula.split('').map(Number);
            const provinceCode = parseInt(cedula.substring(0, 2));
            
            if (provinceCode < 1 || provinceCode > 24) return false;
            
            const lastDigit = digits[9];
            const coefficients = [2, 1, 2, 1, 2, 1, 2, 1, 2];
            let sum = 0;
            
            for (let i = 0; i < 9; i++) {
                let result = digits[i] * coefficients[i];
                if (result > 9) result -= 9;
                sum += result;
            }
            
            const calculatedDigit = sum % 10 === 0 ? 0 : 10 - (sum % 10);
            return calculatedDigit === lastDigit;
        }

        // Funciones de utilidad para mostrar mensajes
        function mostrarError(mensaje) {
            // Remover mensajes anteriores
            document.querySelectorAll('.error, .success').forEach(el => el.remove());
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = mensaje;
            
            const authSection = document.querySelector('.auth-section');
            authSection.appendChild(errorDiv);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function mostrarExito(mensaje) {
            // Remover mensajes anteriores
            document.querySelectorAll('.error, .success').forEach(el => el.remove());
            
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = mensaje;
            
            const authSection = document.querySelector('.auth-section');
            authSection.appendChild(successDiv);
            
            setTimeout(() => successDiv.remove(), 3000);
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            updateAuthUI(false);
        });
    </script>
</body>
</html>